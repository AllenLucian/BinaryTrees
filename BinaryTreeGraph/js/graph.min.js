Ext.define("MJ.Graph",{statics:{BG_FILL:"white",NODE_FILL:"#f92672",NODE_STROKE:"#424242",TEXT_FILL:"white",LINK_STROKE:"#424242",ARROW_FILL:"yellow",FONT_SIZE:20,FONT_FAMILY:"Consolas",X_SPACE:10,Y_SPACE:30,LINE_WIDTH:30,LINK_TYPE_ELBOW:"elbow",LINK_TYPE_LINE:"line"},config:{tree:null,root:null,nodes:null,maxWidth:0,minX:0,paperWidth:0,paperHeight:0,paper:null,linkType:null},constructor:function(t){this.initConfig(t)},display:function(){var t=this.tree?this.tree.getRoot():null;return t?(this.root=new MJ.Graph.Node({string:this.tree.getString(t),btNode:t}),this.nodes=[],this._fillNodes(),this._placeNodes(),this._compressNodes(),this._measureNodes(),this._displayNodes(),this):($("#paper").find("svg").empty(),this)},_addNode:function(t,e){var i=null;return e?(i=new MJ.Graph.Node({string:this.tree.getString(e),btNode:e}),t.push(i),this.maxWidth=Math.max(this.maxWidth,i.width)):t.push(null),i},_fillNodes:function(){var t,e,i,h,n,r,s,a=[];for(a.push(this.root),this.nodes.push(a);;){t=this.nodes[this.nodes.length-1],e=[],i=!1;for(h in t)(n=t[h])?((r=this._addNode(e,this.tree.getLeft(n.btNode)))&&(n.left=r,r.parent=n,r.level=n.level+1,i=!0),(s=this._addNode(e,this.tree.getRight(n.btNode)))&&(n.right=s,s.parent=n,s.level=n.level+1,i=!0)):(e.push(null),e.push(null));if(!i)break;this.nodes.push(e)}},_placeNodes:function(){var t,e,i,h,n,r,s,a,l=this.nodes.length,o=[],p=MJ.textSize(MJ.Graph.FONT_SIZE+"px",MJ.Graph.FONT_FAMILY,"6哈j]】").height,g=this.nodes[l-1].length,d=this.maxWidth,u=g*this.maxWidth+d*(g-1);for(t=0;t<l;t++)for(e=this.nodes[t],i=[],o.push(i),n=(u-((h=e.length)-1)*d)/h-this.maxWidth,n>>=1,r=0,s=0;s<h;s++)0!==s&&(r+=d),r+=n,(a=e[s])&&(a.x=r,a.height=p,a.y=t*(p+MJ.Graph.Y_SPACE),i.push(a)),r+=this.maxWidth,r+=n;this.nodes=o},_compressNodes:function(){var t,e,i,h,n,r,s,a,l,o,p=this.nodes.length;if(!(p<2))for(t=p-2;t>=0;t--){e=this.nodes[t];for(i in e)if(h=e[i],n=h.left,r=h.right,n||r)if(n&&r){if(h.balance(n,r),s=h.leftBoundEmptyLength(),a=h.rightBoundEmptyLength(),l=Math.min(s,a),l=Math.min(l,r.x-n.rightX()>>1),o=n.minLevelSpaceToRight(r)-MJ.Graph.X_SPACE,(o=Math.min(o>>1,l))>0&&(n.translateX(o),r.translateX(-o)),(o=n.minLevelSpaceToRight(r)-MJ.Graph.X_SPACE)<1)continue;if(s=h.leftBoundEmptyLength(),a=h.rightBoundEmptyLength(),s<1&&a<1)continue;s>a?n.translateX(Math.min(s,o)):r.translateX(-Math.min(a,o))}else n?n.translateX(h.leftBoundEmptyLength()):r.translateX(-h.rightBoundEmptyLength())}},_measureNodes:function(){var t,e,i,h,n,r;this.minX=this.root.x,t=0,e=0;for(i in this.nodes){h=this.nodes[i];for(n in h)r=h[n],this.minX=Math.min(this.minX,r.x),t=Math.max(t,r.rightX()),e=Math.max(e,r.y+r.height)}this.paperWidth=t-this.minX,this.paperHeight=e},_displayNode:function(t,e){var i,h,n=new joint.shapes.standard.Rectangle;n.position(e.x-this.minX,e.y),n.resize(e.width,e.height),n.attr({body:{fill:MJ.Graph.NODE_FILL,stroke:MJ.Graph.NODE_STROKE},label:{text:e.string,fill:MJ.Graph.TEXT_FILL,fontSize:MJ.Graph.FONT_SIZE,fontFamily:MJ.Graph.FONT_FAMILY}}),t.push(n),e.cell=n,e.parent&&((i=new joint.shapes.standard.Link).attr({line:{stroke:MJ.Graph.LINK_STROKE,targetMarker:{fill:MJ.Graph.ARROW_FILL}}}),h="left",e===e.parent.right&&(h="right"),i.source(e.parent.cell,{anchor:{name:h}}),this.linkType&&this.linkType!==MJ.Graph.LINK_TYPE_ELBOW||(i.router("orthogonal",{padding:10}),i.connector("jumpover")),i.target(n,{anchor:{name:"top"}}),t.push(i))},_displayNodes:function(){var t,e,i,h,n,r,s,a,l,o,p,g,d,u=$("#paper");u.empty(),u.css("display","block"),t=new joint.dia.Graph,i=(e=20)<<1,h=500,n=500,r=Math.max(h,this.paperWidth)+i,s=Math.max(n,this.paperHeight)+i,this.paper=new joint.dia.Paper({el:u,width:r,height:s,model:t,drawGrid:!0,gridSize:10,background:{color:MJ.Graph.BG_FILL}}),a=e,l=e,h>this.paperWidth&&(a+=h-this.paperWidth>>1),n>this.paperHeight&&(l+=n-this.paperHeight>>1),this.paper.translate(a,l),o=[];for(p in this.nodes){g=this.nodes[p];for(d in g)this._displayNode(o,g[d])}t.addCells(o)}}),Ext.define("MJ.Graph.Node",{config:{left:null,right:null,parent:null,string:null,x:0,y:0,width:0,height:0,level:0,btNode:null,cell:null,treeHeight:0},constructor:function(t){this.initConfig(t),this.callParent(arguments)},getTreeHeight:function(){return this.treeHeight>0?this.treeHeight:(this.treeHeight=this._getTreeHeight(this),this.treeHeight)},_getTreeHeight:function(t){var e,i,h;return t?(e=this._getTreeHeight(t.left),i=this._getTreeHeight(t.right),h=1+Math.max(e,i),t.treeHeight=h):0},minLevelSpaceToRight:function(t){var e,i,h=Math.min(this.getTreeHeight(),t.getTreeHeight()),n=Number.MAX_VALUE;for(e=0;e<h;e++)i=t.levelInfo(e).leftX-this.levelInfo(e).rightX,n=Math.min(n,i);return n},levelInfo:function(t){var e,i,h,n,r,s;if(t<0)return null;if(t>=this.getTreeHeight())return null;for(e=[],(i=[]).push(this),h=this.level+t;i.length>0;){if(n=i.shift(),h===n.level)e.push(n);else if(n.level>h)break;n.left&&i.push(n.left),n.right&&i.push(n.right)}return r=e[0].leftBound(),s=e[e.length-1].rightBound(),{leftX:r,rightX:s}},topLineX:function(){var t=this.width;return t%2==0&&t--,t>>=1,this.parent&&this===this.parent.left?this.rightX()-1-t:this.x+t},leftBoundLength:function(){return this.x-this.leftBound()},rightBoundLength:function(){return this.rightBound()-this.rightX()},leftBoundEmptyLength:function(){return this.leftBoundLength()-1-MJ.Graph.LINE_WIDTH},rightBoundEmptyLength:function(){return this.rightBoundLength()-1-MJ.Graph.LINE_WIDTH},rightBound:function(){return this.right?this.right.topLineX()+1+MJ.Graph.X_SPACE:this.rightX()},leftBound:function(){return this.left?this.left.topLineX()-MJ.Graph.X_SPACE:this.x},balance:function(t,e){var i,h,n,r,s;t&&e&&(i=this.x-t.rightX(),h=e.x-this.rightX(),n=Math.max(i,h),r=this.rightX()+n,e.translateX(r-e.x),s=this.x-n-t.width,t.translateX(s-t.x))},translateX:function(t){0!==t&&(this.x+=t,this.left&&this.left.translateX(t),this.right&&this.right.translateX(t))},rightX:function(){return this.x+this.width},setParent:function(t){this.callParent(arguments),this.level=t.level+1},setString:function(t){this.string=t;var e=MJ.textSize(MJ.Graph.FONT_SIZE+"px",MJ.Graph.FONT_FAMILY,t);this.width=e.width+15}});